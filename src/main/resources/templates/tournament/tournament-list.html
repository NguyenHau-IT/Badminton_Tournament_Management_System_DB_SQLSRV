<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/base}">

<head>
    <title th:text="${pageTitle}">Danh s√°ch Gi·∫£i ƒë·∫•u - BTMS</title>

    <!-- Page-specific CSS -->
    <th:block layout:fragment="page-css">
        <link rel="stylesheet" th:href="@{/css/tournament/tournament-list.css}">
    </th:block>
</head>

<body>
    <div layout:fragment="content" class="tournaments-page">
        <!-- Page Header -->
        <div class="page-header">
            <div class="container">
                <h1 data-aos="fade-up">
                    <i class="bi bi-trophy"></i> Danh s√°ch Gi·∫£i ƒë·∫•u
                </h1>
                <p class="lead mb-0" data-aos="fade-up" data-aos-delay="100">
                    Kh√°m ph√° v√† tham gia c√°c gi·∫£i ƒë·∫•u c·∫ßu l√¥ng h·∫•p d·∫´n
                </p>
            </div>
        </div>

        <div class="container">
            <!-- Stats Section -->
            <div class="stats-section" data-aos="fade-up">
                <div class="row">
                    <div class="col-md-3 col-6 mb-3 mb-md-0">
                        <div class="stat-item">
                            <div class="stat-value" th:text="${totalItems}">8</div>
                            <div class="stat-label">T·ªïng s·ªë gi·∫£i</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6 mb-3 mb-md-0">
                        <div class="stat-item">
                            <div class="stat-value" th:text="${statsByStatus['ongoing'] ?: 0}">1</div>
                            <div class="stat-label">ƒêang di·ªÖn ra</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-item">
                            <div class="stat-value" th:text="${statsByStatus['upcoming'] ?: 0}">4</div>
                            <div class="stat-label">S·∫Øp di·ªÖn ra</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-item">
                            <div class="stat-value" th:text="${statsByStatus['registration'] ?: 0}">2</div>
                            <div class="stat-label">ƒêang ƒëƒÉng k√Ω</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advanced Filter Panel -->
            <div class="advanced-filter-panel" data-aos="fade-up">
                <!-- Filter Header with Toggle -->
                <div class="filter-header" id="filterHeader">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">
                            <i class="bi bi-funnel-fill"></i> B·ªô l·ªçc n√¢ng cao
                            <span class="filter-count-badge" id="filterCountBadge" style="display: none;">0</span>
                        </h5>
                        <button class="btn btn-link text-decoration-none text-white" type="button" id="toggleFilterBtn" data-bs-toggle="collapse" data-bs-target="#filterBody" aria-expanded="false" aria-controls="filterBody">
                            <i class="bi bi-chevron-down" id="toggleFilterIcon"></i>
                            <span id="toggleFilterText">M·ªü r·ªông</span>
                        </button>
                    </div>
                </div>

                <!-- Collapsible Filter Body -->
                <div class="filter-body collapse" id="filterBody" aria-labelledby="filterHeader">
                    <form id="advancedFilterForm" class="mt-3">
                        <div class="row g-3">
                            <!-- Status Multi-Select -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">
                                    <i class="bi bi-toggle-on"></i> Tr·∫°ng th√°i
                                </label>
                                <select class="form-select filter-select" id="statusFilter" multiple size="4">
                                    <option value="ongoing">üî¥ ƒêang di·ªÖn ra</option>
                                    <option value="registration">üü¢ ƒêang ƒëƒÉng k√Ω</option>
                                    <option value="upcoming">üîµ S·∫Øp di·ªÖn ra</option>
                                    <option value="completed">‚ö´ ƒê√£ k·∫øt th√∫c</option>
                                </select>
                            </div>

                            <!-- Province Select -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">
                                    <i class="bi bi-geo-alt"></i> T·ªânh/Th√†nh ph·ªë
                                </label>
                                <select class="form-select filter-select" id="provinceFilter">
                                    <option value="">T·∫•t c·∫£</option>
                                    <option value="TP. H·ªì Ch√≠ Minh">TP. H·ªì Ch√≠ Minh</option>
                                    <option value="H√† N·ªôi">H√† N·ªôi</option>
                                    <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                                    <option value="C·∫ßn Th∆°">C·∫ßn Th∆°</option>
                                    <option value="H·∫£i Ph√≤ng">H·∫£i Ph√≤ng</option>
                                    <option value="ƒê·ªìng Nai">ƒê·ªìng Nai</option>
                                    <option value="B√¨nh D∆∞∆°ng">B√¨nh D∆∞∆°ng</option>
                                    <option value="Kh√°c">Kh√°c...</option>
                                </select>
                            </div>

                            <!-- Level Select -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">
                                    <i class="bi bi-trophy"></i> C·∫•p ƒë·ªô
                                </label>
                                <select class="form-select filter-select" id="levelFilter" multiple size="4">
                                    <option value="Qu·ªëc t·∫ø">üåç Qu·ªëc t·∫ø</option>
                                    <option value="Chuy√™n nghi·ªáp">‚≠ê Chuy√™n nghi·ªáp</option>
                                    <option value="Nghi·ªáp d∆∞">üë§ Nghi·ªáp d∆∞</option>
                                    <option value="H·ªçc sinh">üéì H·ªçc sinh</option>
                                </select>
                            </div>

                            <!-- Type Select -->
                            <div class="col-md-6 col-lg-3">
                                <label class="form-label">
                                    <i class="bi bi-people"></i> Lo·∫°i n·ªôi dung
                                </label>
                                <select class="form-select filter-select" id="typeFilter" multiple size="4">
                                    <option value="ƒê∆°n nam">üë® ƒê∆°n nam</option>
                                    <option value="ƒê∆°n n·ªØ">üë© ƒê∆°n n·ªØ</option>
                                    <option value="ƒê√¥i nam">üë¨ ƒê√¥i nam</option>
                                    <option value="ƒê√¥i n·ªØ">üë≠ ƒê√¥i n·ªØ</option>
                                    <option value="ƒê√¥i nam n·ªØ">üë´ ƒê√¥i nam n·ªØ</option>
                                </select>
                            </div>

                            <!-- Date Range -->
                            <div class="col-md-6 col-lg-4">
                                <label class="form-label">
                                    <i class="bi bi-calendar-range"></i> Ng√†y b·∫Øt ƒë·∫ßu
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">T·ª´</span>
                                    <input type="date" class="form-control" id="dateFromFilter">
                                </div>
                                <div class="input-group mt-2">
                                    <span class="input-group-text">ƒê·∫øn</span>
                                    <input type="date" class="form-control" id="dateToFilter">
                                </div>
                            </div>

                            <!-- Price Range Slider -->
                            <div class="col-md-6 col-lg-4">
                                <label class="form-label">
                                    <i class="bi bi-currency-dollar"></i> Ph√≠ tham gia
                                    <span class="text-muted" id="priceRangeDisplay">0ƒë - 2,000,000ƒë</span>
                                </label>
                                <div class="price-slider-container">
                                    <input type="range" class="form-range" id="priceMinFilter" min="0" max="2000000" step="100000" value="0">
                                    <input type="range" class="form-range mt-2" id="priceMaxFilter" min="0" max="2000000" step="100000" value="2000000">
                                    <div class="price-labels d-flex justify-content-between mt-1">
                                        <small id="priceMinLabel">0ƒë</small>
                                        <small id="priceMaxLabel">2,000,000ƒë</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="col-md-12 col-lg-4">
                                <label class="form-label d-block">&nbsp;</label>
                                <button type="submit" class="btn btn-primary btn-apply-filter w-100 mb-2" id="applyFiltersBtn">
                                    <i class="bi bi-check-circle"></i> √Åp d·ª•ng b·ªô l·ªçc
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-reset-filter w-100" id="resetFiltersBtn">
                                    <i class="bi bi-arrow-clockwise"></i> ƒê·∫∑t l·∫°i
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Toolbar: Sort + View Toggle -->
            <div class="list-toolbar" data-aos="fade-up">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <!-- Results Count -->
                    <div class="results-info">
                        <span class="results-count">
                            <i class="bi bi-list-check"></i>
                            <strong th:text="${totalItems}">8</strong> gi·∫£i ƒë·∫•u
                        </span>
                    </div>

                    <!-- Right Controls: Sort + View Toggle -->
                    <div class="d-flex align-items-center gap-3 flex-wrap">
                        <!-- Sort Dropdown -->
                        <div class="sort-dropdown-container">
                            <label class="me-2 mb-0">
                                <i class="bi bi-sort-down"></i> S·∫Øp x·∫øp:
                            </label>
                            <div class="dropdown d-inline-block">
                                <button class="btn btn-outline-primary dropdown-toggle sort-dropdown-btn" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    <span id="sortSelectedText">M·ªõi nh·∫•t</span>
                                </button>
                            <ul class="dropdown-menu dropdown-menu-end sort-dropdown-menu" aria-labelledby="sortDropdown">
                                <li>
                                    <a class="dropdown-item sort-option active" href="#" data-sort="newest">
                                        <i class="bi bi-calendar-plus"></i>
                                        <span>M·ªõi nh·∫•t</span>
                                        <i class="bi bi-check-circle-fill check-icon"></i>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item sort-option" href="#" data-sort="most-viewed">
                                        <i class="bi bi-eye"></i>
                                        <span>Xem nhi·ªÅu nh·∫•t</span>
                                        <i class="bi bi-check-circle-fill check-icon"></i>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item sort-option" href="#" data-sort="highest-rated">
                                        <i class="bi bi-star-fill"></i>
                                        <span>ƒê√°nh gi√° cao nh·∫•t</span>
                                        <i class="bi bi-check-circle-fill check-icon"></i>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item sort-option" href="#" data-sort="price-low">
                                        <i class="bi bi-cash-coin"></i>
                                        <span>Ph√≠ th·∫•p ƒë·∫øn cao</span>
                                        <i class="bi bi-check-circle-fill check-icon"></i>
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item sort-option" href="#" data-sort="price-high">
                                        <i class="bi bi-cash-stack"></i>
                                        <span>Ph√≠ cao ƒë·∫øn th·∫•p</span>
                                        <i class="bi bi-check-circle-fill check-icon"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        </div>

                        <!-- View Toggle Buttons -->
                        <div class="view-toggle-group">
                            <button class="btn-view-toggle active" data-view="grid" type="button" 
                                    title="Ch·∫ø ƒë·ªô l∆∞·ªõi">
                                <i class="bi bi-grid-3x3-gap"></i>
                            </button>
                            <button class="btn-view-toggle" data-view="list" type="button"
                                    title="Ch·∫ø ƒë·ªô danh s√°ch">
                                <i class="bi bi-list-ul"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tournaments Grid -->
            <div class="row g-4 view-mode grid-view" id="tournamentsContainer" th:if="${!tournaments.empty}">
                <div class="col-lg-4 col-md-6 tournament-col" th:each="tournament : ${tournaments}" data-aos="fade-up"
                    th:attr="data-aos-delay=${tournamentStat.index * 100}">
                    <div class="tournament-card">
                        <!-- Image -->
                        <div class="tournament-image">
                            <img th:src="${tournament.hinhAnh != null && !tournament.hinhAnh.isEmpty() ? tournament.hinhAnh : '/icons/tournaments/default.svg'}" 
                                 th:alt="${tournament.tenGiai}"
                                 loading="lazy"
                                 onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';">

                            <!-- Quick View Button -->
                            <button class="btn btn-light btn-quick-view rounded-pill shadow" 
                                    th:data-tournament-id="${tournament.id}"
                                    onclick="openQuickView(this.getAttribute('data-tournament-id'))">
                                <i class="bi bi-eye"></i> Xem nhanh
                            </button>

                            <!-- Status Badge -->
                            <div th:if="${tournament.trangThai == 'ongoing'}" class="status-badge badge-ongoing">
                                <i class="bi bi-broadcast"></i> LIVE
                            </div>
                            <div th:if="${tournament.trangThai == 'registration'}" class="status-badge badge-registration">
                                <i class="bi bi-pencil-square"></i> ƒêang ƒëƒÉng k√Ω
                            </div>
                            <div th:if="${tournament.trangThai == 'upcoming'}" class="status-badge badge-upcoming">
                                <i class="bi bi-clock"></i> S·∫Øp di·ªÖn ra
                            </div>
                            <div th:if="${tournament.trangThai == 'completed'}" class="status-badge badge-completed">
                                <i class="bi bi-check-circle"></i> ƒê√£ k·∫øt th√∫c
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="tournament-content">
                            <h3 class="tournament-title" th:text="${tournament.tenGiai}">
                                T√™n gi·∫£i ƒë·∫•u
                            </h3>

                            <div class="tournament-meta">
                                <span class="meta-item">
                                    <i class="bi bi-calendar3"></i>
                                    <span th:text="${tournament.ngayBatDau}">Ng√†y</span>
                                </span>
                                <span class="meta-item">
                                    <i class="bi bi-geo-alt"></i>
                                    <span th:text="${tournament.tinhThanh}">ƒê·ªãa ƒëi·ªÉm</span>
                                </span>
                            </div>

                            <div class="tournament-footer">
                                <span class="tournament-category" th:text="${tournament.capDo}">
                                    Category
                                </span>
                                <a th:href="@{/tournaments/{id}(id=${tournament.id})}" class="btn btn-primary btn-sm">
                                    Chi ti·∫øt <i class="bi bi-arrow-right"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" th:if="${tournaments.empty}">
                <i class="bi bi-inbox"></i>
                <h3>Kh√¥ng t√¨m th·∫•y gi·∫£i ƒë·∫•u</h3>
                <p class="text-muted">Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c quay l·∫°i sau.</p>
                <a th:href="@{/tournaments}" class="btn btn-primary">
                    <i class="bi bi-arrow-left"></i> Xem t·∫•t c·∫£
                </a>
            </div>

            <!-- Pagination (Hidden - Using Infinite Scroll) -->
            <!-- Infinite scroll is enabled via JavaScript in tournament-list.js -->
            <!-- Traditional pagination kept here for fallback/SEO purposes -->
            <nav th:if="${totalPages > 1}" aria-label="Tournament pagination" style="display: none;" id="traditionalPagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                        <a class="page-link"
                            th:href="@{/tournaments(page=${currentPage - 1}, status=${selectedStatus}, category=${selectedCategory})}">
                            Tr∆∞·ªõc
                        </a>
                    </li>

                    <li class="page-item" th:each="i : ${#numbers.sequence(1, totalPages)}"
                        th:classappend="${i == currentPage ? 'active' : ''}">
                        <a class="page-link"
                            th:href="@{/tournaments(page=${i}, status=${selectedStatus}, category=${selectedCategory})}"
                            th:text="${i}">1</a>
                    </li>

                    <li class="page-item" th:classappend="${currentPage == totalPages ? 'disabled' : ''}">
                        <a class="page-link"
                            th:href="@{/tournaments(page=${currentPage + 1}, status=${selectedStatus}, category=${selectedCategory})}">
                            Sau
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Quick View Modal -->
        <div class="modal fade" id="quickViewModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header border-0">
                        <h5 class="modal-title" id="quickViewModalLabel">
                            <i class="bi bi-eye"></i> Xem nhanh
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0">
                        <!-- Loading State -->
                        <div id="quickViewLoading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">ƒêang t·∫£i th√¥ng tin gi·∫£i ƒë·∫•u...</p>
                        </div>

                        <!-- Content Container -->
                        <div id="quickViewContent" style="display: none;">
                            <!-- Tournament Header -->
                            <div class="quick-view-header">
                                <div class="position-relative">
                                    <img id="qvTournamentImage" 
                                         src="" 
                                         alt="Tournament" 
                                         class="w-100"
                                         style="height: 300px; object-fit: cover;">
                                    <div class="position-absolute top-0 start-0 w-100 h-100" 
                                         style="background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.7));">
                                    </div>
                                    <div class="position-absolute bottom-0 start-0 p-4 text-white w-100">
                                        <span id="qvStatus" class="badge bg-danger mb-2">Status</span>
                                        <h2 id="qvTournamentName" class="mb-2">Tournament Name</h2>
                                        <div class="d-flex align-items-center gap-3 flex-wrap">
                                            <span><i class="bi bi-calendar-event"></i> <span id="qvDate">Date</span></span>
                                            <span><i class="bi bi-geo-alt"></i> <span id="qvLocation">Location</span></span>
                                            <span><i class="bi bi-people"></i> <span id="qvParticipants">Participants</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Tournament Details -->
                            <div class="quick-view-body p-4">
                                <div class="row">
                                    <!-- Left Column -->
                                    <div class="col-lg-8">
                                        <!-- Description -->
                                        <div class="mb-4">
                                            <h5 class="mb-3">
                                                <i class="bi bi-info-circle"></i> Gi·ªõi thi·ªáu
                                            </h5>
                                            <div id="qvDescription" class="text-muted">
                                                Description content...
                                            </div>
                                        </div>

                                        <!-- Competition Format -->
                                        <div class="mb-4">
                                            <h5 class="mb-3">
                                                <i class="bi bi-diagram-3"></i> Th·ªÉ th·ª©c thi ƒë·∫•u
                                            </h5>
                                            <div id="qvFormat" class="text-muted">
                                                Format details...
                                            </div>
                                        </div>

                                        <!-- Prize -->
                                        <div class="mb-4">
                                            <h5 class="mb-3">
                                                <i class="bi bi-trophy"></i> Gi·∫£i th∆∞·ªüng
                                            </h5>
                                            <div id="qvPrize" class="text-muted">
                                                Prize information...
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right Column -->
                                    <div class="col-lg-4">
                                        <!-- Quick Info Card -->
                                        <div class="card shadow-sm mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title mb-3">
                                                    <i class="bi bi-list-check"></i> Th√¥ng tin chi ti·∫øt
                                                </h6>
                                                <ul class="list-unstyled mb-0">
                                                    <li class="mb-2">
                                                        <small class="text-muted">C·∫•p ƒë·ªô:</small>
                                                        <strong id="qvLevel" class="d-block">Level</strong>
                                                    </li>
                                                    <li class="mb-2">
                                                        <small class="text-muted">Th·ªÉ lo·∫°i:</small>
                                                        <strong id="qvType" class="d-block">Type</strong>
                                                    </li>
                                                    <li class="mb-2">
                                                        <small class="text-muted">Ph√≠ tham gia:</small>
                                                        <strong id="qvFee" class="d-block text-success">Fee</strong>
                                                    </li>
                                                    <li class="mb-2">
                                                        <small class="text-muted">H·∫°n ƒëƒÉng k√Ω:</small>
                                                        <strong id="qvDeadline" class="d-block text-danger">Deadline</strong>
                                                    </li>
                                                    <li class="mb-2">
                                                        <small class="text-muted">S·ªë l∆∞·ª£ng ƒë√£ ƒëƒÉng k√Ω:</small>
                                                        <strong id="qvRegistered" class="d-block">0/100</strong>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        <!-- Stats Card -->
                                        <div class="card shadow-sm mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title mb-3">
                                                    <i class="bi bi-bar-chart"></i> Th·ªëng k√™
                                                </h6>
                                                <div class="d-flex justify-content-around text-center">
                                                    <div>
                                                        <div class="h4 mb-0" id="qvViews">0</div>
                                                        <small class="text-muted">L∆∞·ª£t xem</small>
                                                    </div>
                                                    <div>
                                                        <div class="h4 mb-0 text-warning">
                                                            <i class="bi bi-star-fill"></i>
                                                            <span id="qvRating">0.0</span>
                                                        </div>
                                                        <small class="text-muted">ƒê√°nh gi√°</small>
                                                    </div>
                                                    <div>
                                                        <div class="h4 mb-0" id="qvReviews">0</div>
                                                        <small class="text-muted">B√¨nh lu·∫≠n</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="d-grid gap-2">
                                            <a id="qvViewDetailsBtn" href="#" class="btn btn-primary btn-lg">
                                                <i class="bi bi-box-arrow-up-right"></i> Xem chi ti·∫øt
                                            </a>
                                            <button id="qvRegisterBtn" class="btn btn-success btn-lg">
                                                <i class="bi bi-pencil-square"></i> ƒêƒÉng k√Ω tham gia
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error State -->
                        <div id="quickViewError" class="text-center py-5" style="display: none;">
                            <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                            <h5 class="mt-3">Kh√¥ng th·ªÉ t·∫£i th√¥ng tin</h5>
                            <p class="text-muted">Vui l√≤ng th·ª≠ l·∫°i sau</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page-specific JavaScript -->
    <th:block layout:fragment="page-scripts">
        <script th:src="@{/js/tournament/tournament-list.js(v=${#temporals.format(#temporals.createNow(), 'yyyyMMddHHmmss')})}"></script>
    </th:block>
</body>

</html>