<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTMS API Test Tool - v2.0.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .config-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .config-panel h3 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .config-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }

        .config-row label {
            min-width: 100px;
            font-weight: bold;
        }

        .config-row input, .config-row select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .config-row input[type="text"] {
            width: 200px;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .left-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .right-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            flex-wrap: wrap;
        }

        .tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            flex: 1;
            min-width: 120px;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .api-section {
            margin-bottom: 30px;
        }

        .api-section h4 {
            color: #495057;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 5px;
        }

        .api-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .api-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .api-btn.get {
            background: #28a745;
            color: white;
        }

        .api-btn.post {
            background: #007bff;
            color: white;
        }

        .api-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .api-btn:active {
            transform: translateY(0);
        }

        .response-area {
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #404040;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            height: 100%;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }

        .log-header {
            background: #2d2d30;
            color: white;
            padding: 15px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .log-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .loading {
            color: #ffcc02;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }

        .info {
            color: #9cdcfe;
        }

        .request {
            color: #dcdcaa;
        }

        .response {
            color: #ce9178;
        }

        .sse-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }

        .sse-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .sse-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .sse-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .snapshot-display {
            background: #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }

        .snapshot-display h5 {
            margin-bottom: 10px;
            color: #495057;
        }

        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .team-score {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            min-width: 100px;
        }

        .clear-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-btn:hover {
            background: #5a6268;
        }

        .pin-input {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .pin-input h5 {
            margin-bottom: 10px;
            color: #856404;
        }

        .url-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .method-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 8px;
        }

        .method-get {
            background: #28a745;
            color: white;
        }

        .method-post {
            background: #007bff;
            color: white;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #28a745;
        }

        .status-error {
            background: #dc3545;
        }

        .status-loading {
            background: #ffc107;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .timestamp {
            color: #6c757d;
            font-size: 11px;
        }

        @media (max-width: 1024px) {
            .main-layout {
                flex-direction: column;
            }

            .right-panel {
                min-height: 400px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .config-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .config-row label {
                min-width: auto;
            }

            .config-row input[type="text"] {
                width: 100%;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                flex: none;
                min-width: auto;
            }

            .api-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∏ BTMS API Test Tool</h1>
            <p>Badminton Tournament Management System - API Testing Interface v2.0.0</p>
        </div>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <h3>‚öôÔ∏è C·∫•u h√¨nh k·∫øt n·ªëi</h3>
            <div class="config-row">
                <label>Base URL:</label>
                <input type="text" id="baseUrl" value="http://localhost:2345" placeholder="http://localhost:2345">
                <label>Mode:</label>
                <select id="apiMode">
                    <option value="pin">PIN Mode (Multi-court)</option>
                    <option value="no-pin">No-PIN Mode (Single scoreboard)</option>
                </select>
            </div>
            <div class="config-row" id="pinRow">
                <label>PIN Code:</label>
                <input type="text" id="pinCode" value="1234" placeholder="Enter PIN code">
                <button onclick="validatePin()" class="api-btn get" style="padding: 8px 15px;">Validate PIN</button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Panel - Controls -->
            <div class="left-panel">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('info')">üìä Th√¥ng tin</button>
                    <button class="tab" onclick="switchTab('score')">üéØ ƒêi·ªÅu khi·ªÉn ƒëi·ªÉm</button>
                    <button class="tab" onclick="switchTab('match')">üèÜ ƒêi·ªÅu khi·ªÉn tr·∫≠n</button>
                    <button class="tab" onclick="switchTab('stream')">üì° Real-time Stream</button>
                    <button class="tab" onclick="switchTab('debug')">üîß Debug & Test</button>
                </div>

                <div class="tab-content">
                    <!-- Info Tab -->
                    <div id="info" class="tab-pane active">
                        <div class="api-section">
                            <h4>üìã Th√¥ng tin c∆° b·∫£n</h4>
                            <div class="api-buttons">
                                <button class="api-btn get" onclick="callApi('health', 'GET')">
                                    <span class="method-badge method-get">GET</span> Health Check
                                </button>
                                <button class="api-btn get" onclick="callApi('basic', 'GET')">
                                    <span class="method-badge method-get">GET</span> Basic Info
                                </button>
                                <button class="api-btn get" onclick="callApi('status', 'GET')" id="statusBtn">
                                    <span class="method-badge method-get">GET</span> Status (PIN only)
                                </button>
                                <button class="api-btn get" onclick="callApi('sync', 'GET')">
                                    <span class="method-badge method-get">GET</span> Full Snapshot
                                </button>
                            </div>
                            
                            <div class="snapshot-display" id="snapshotDisplay" style="display: none;">
                                <h5>üìä Current Match Snapshot:</h5>
                                <div class="score-display">
                                    <div class="team-score">
                                        <div id="teamAName">Team A</div>
                                        <div id="teamAScore">0</div>
                                        <div id="teamAGames">Games: 0</div>
                                    </div>
                                    <div style="font-size: 2em;">VS</div>
                                    <div class="team-score">
                                        <div id="teamBName">Team B</div>
                                        <div id="teamBScore">0</div>
                                        <div id="teamBGames">Games: 0</div>
                                    </div>
                                </div>
                                <div style="text-align: center; margin-top: 10px;">
                                    <div>Game: <span id="gameNumber">1</span> | Best of: <span id="bestOf">3</span></div>
                                    <div>Server: <span id="server">Team A</span> | Mode: <span id="matchType">Singles</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Score Control Tab -->
                    <div id="score" class="tab-pane">
                        <div class="api-section">
                            <h4>üìà ƒêi·ªÅu khi·ªÉn ƒëi·ªÉm Team A</h4>
                            <div class="api-buttons">
                                <button class="api-btn post" onclick="callApi('increaseA', 'POST')">
                                    <span class="method-badge method-post">POST</span> TƒÉng ƒëi·ªÉm A (+1)
                                </button>
                                <button class="api-btn post" onclick="callApi('decreaseA', 'POST')">
                                    <span class="method-badge method-post">POST</span> Gi·∫£m ƒëi·ªÉm A (-1)
                                </button>
                            </div>
                        </div>

                        <div class="api-section">
                            <h4>üìâ ƒêi·ªÅu khi·ªÉn ƒëi·ªÉm Team B</h4>
                            <div class="api-buttons">
                                <button class="api-btn post" onclick="callApi('increaseB', 'POST')">
                                    <span class="method-badge method-post">POST</span> TƒÉng ƒëi·ªÉm B (+1)
                                </button>
                                <button class="api-btn post" onclick="callApi('decreaseB', 'POST')">
                                    <span class="method-badge method-post">POST</span> Gi·∫£m ƒëi·ªÉm B (-1)
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Match Control Tab -->
                    <div id="match" class="tab-pane">
                        <div class="api-section">
                            <h4>üîÑ ƒêi·ªÅu khi·ªÉn tr·∫≠n ƒë·∫•u</h4>
                            <div class="api-buttons">
                                <button class="api-btn post" onclick="callApi('reset', 'POST')">
                                    <span class="method-badge method-post">POST</span> Reset Match
                                </button>
                                <button class="api-btn post" onclick="callApi('next', 'POST')">
                                    <span class="method-badge method-post">POST</span> Next Game
                                </button>
                                <button class="api-btn post" onclick="callApi('swap', 'POST')">
                                    <span class="method-badge method-post">POST</span> Swap Ends
                                </button>
                                <button class="api-btn post" onclick="callApi('change-server', 'POST')">
                                    <span class="method-badge method-post">POST</span> Change Server
                                </button>
                                <button class="api-btn post" onclick="callApi('undo', 'POST')">
                                    <span class="method-badge method-post">POST</span> Undo Last Action
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SSE Stream Tab -->
                    <div id="stream" class="tab-pane">
                        <div class="api-section">
                            <h4>üì° Server-Sent Events (Real-time)</h4>
                            <div class="sse-controls">
                                <button class="api-btn get" onclick="startSSE()" id="connectBtn">
                                    Connect to Stream
                                </button>
                                <button class="api-btn" onclick="stopSSE()" id="disconnectBtn" style="background: #dc3545; color: white;">
                                    Disconnect
                                </button>
                                <div class="sse-status disconnected" id="sseStatus">Disconnected</div>
                            </div>
                            <div class="url-display" id="sseUrl">Stream URL will appear here</div>
                            <p style="margin-bottom: 15px; color: #6c757d;">
                                <strong>Ch√∫ √Ω:</strong> SSE stream s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t khi c√≥ thay ƒë·ªïi t·ª´ c√°c API kh√°c. 
                                H√£y th·ª≠ g·ªçi API ƒëi·ªÅu khi·ªÉn ƒëi·ªÉm ho·∫∑c tr·∫≠n ƒë·∫•u ·ªü tab kh√°c ƒë·ªÉ xem real-time updates.
                            </p>
                        </div>
                    </div>

                    <!-- Debug Tab -->
                    <div id="debug" class="tab-pane">
                        <div class="api-section">
                            <h4>üß™ Debug & Testing</h4>
                            <div class="api-buttons">
                                <button class="api-btn get" onclick="callApi('test', 'GET')" id="testBtn">
                                    <span class="method-badge method-get">GET</span> Test PIN (PIN only)
                                </button>
                            </div>
                        </div>

                        <div class="api-section">
                            <h4>üéØ Generic Action Endpoint (PIN only)</h4>
                            <p style="margin-bottom: 15px; color: #6c757d;">
                                Endpoint t·ªïng qu√°t ƒë·ªÉ g·ªçi c√°c action th√¥ng qua URL path: POST /api/court/{pin}/{action}
                            </p>
                            <div class="api-buttons">
                                <button class="api-btn post" onclick="callGenericAction('increaseA')">Generic: increaseA</button>
                                <button class="api-btn post" onclick="callGenericAction('decreaseA')">Generic: decreaseA</button>
                                <button class="api-btn post" onclick="callGenericAction('increaseB')">Generic: increaseB</button>
                                <button class="api-btn post" onclick="callGenericAction('decreaseB')">Generic: decreaseB</button>
                                <button class="api-btn post" onclick="callGenericAction('reset')">Generic: reset</button>
                                <button class="api-btn post" onclick="callGenericAction('next')">Generic: next</button>
                                <button class="api-btn post" onclick="callGenericAction('swap')">Generic: swap</button>
                                <button class="api-btn post" onclick="callGenericAction('change-server')">Generic: change-server</button>
                                <button class="api-btn post" onclick="callGenericAction('undo')">Generic: undo</button>
                            </div>
                        </div>

                        <div class="api-section">
                            <h4>üìä Th√¥ng tin k·ªπ thu·∫≠t</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                                <div><strong>CORS:</strong> * (All origins allowed)</div>
                                <div><strong>Content-Type:</strong> application/json; charset=utf-8</div>
                                <div><strong>SSE Content-Type:</strong> text/event-stream</div>
                                <div><strong>Throttling:</strong> ~80ms client-side for web</div>
                                <div><strong>Thread Pool:</strong> 8 threads for SSE broadcast</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Log Area -->
            <div class="right-panel">
                <div class="log-header">
                    <h3>üìã API Response Log</h3>
                    <div class="log-controls">
                        <button class="clear-btn" onclick="clearAllLogs()">Clear All</button>
                        <button class="clear-btn" onclick="toggleAutoScroll()" id="autoScrollBtn">Auto Scroll: ON</button>
                    </div>
                </div>
                <div class="response-area" id="globalResponseLog"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let eventSource = null;
        let apiMode = 'pin';
        let baseUrl = 'http://localhost:2345';
        let pinCode = '1234';
        let autoScroll = true;
        let globalLog = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            globalLog = document.getElementById('globalResponseLog');
            updateModeVisibility();
            
            document.getElementById('apiMode').addEventListener('change', function() {
                apiMode = this.value;
                updateModeVisibility();
            });

            document.getElementById('baseUrl').addEventListener('input', function() {
                baseUrl = this.value;
            });

            document.getElementById('pinCode').addEventListener('input', function() {
                pinCode = this.value;
            });
        });

        // Update UI based on selected mode
        function updateModeVisibility() {
            apiMode = document.getElementById('apiMode').value;
            const pinRow = document.getElementById('pinRow');
            const statusBtn = document.getElementById('statusBtn');
            const testBtn = document.getElementById('testBtn');

            if (apiMode === 'pin') {
                pinRow.style.display = 'flex';
                statusBtn.style.display = 'inline-block';
                testBtn.style.display = 'inline-block';
                document.querySelectorAll('.api-section h4').forEach(h4 => {
                    if (h4.textContent.includes('Generic Action')) {
                        h4.parentElement.style.display = 'block';
                    }
                });
            } else {
                pinRow.style.display = 'none';
                statusBtn.style.display = 'none';
                testBtn.style.display = 'none';
                document.querySelectorAll('.api-section h4').forEach(h4 => {
                    if (h4.textContent.includes('Generic Action')) {
                        h4.parentElement.style.display = 'none';
                    }
                });
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Build API URL
        function buildUrl(endpoint) {
            baseUrl = document.getElementById('baseUrl').value;
            pinCode = document.getElementById('pinCode').value;
            
            if (apiMode === 'pin') {
                const basePath = '/api/court';
                switch(endpoint) {
                    case 'health':
                        return `${baseUrl}${basePath}/health`;
                    case 'basic':
                        return `${baseUrl}${basePath}/${pinCode}`;
                    case 'status':
                        return `${baseUrl}${basePath}/${pinCode}/status`;
                    case 'sync':
                        return `${baseUrl}${basePath}/${pinCode}/sync`;
                    case 'stream':
                        return `${baseUrl}${basePath}/${pinCode}/stream`;
                    case 'test':
                        return `${baseUrl}${basePath}/${pinCode}/test`;
                    default:
                        return `${baseUrl}${basePath}/${pinCode}/${endpoint}`;
                }
            } else {
                const basePath = '/api/scoreboard';
                switch(endpoint) {
                    case 'health':
                        return `${baseUrl}${basePath}/health`; // Note: health might not exist for scoreboard
                    case 'basic':
                        return `${baseUrl}${basePath}`;
                    case 'sync':
                        return `${baseUrl}${basePath}/sync`;
                    case 'stream':
                        return `${baseUrl}${basePath}/stream`;
                    default:
                        return `${baseUrl}${basePath}/${endpoint}`;
                }
            }
        }

        // Call API
        async function callApi(endpoint, method = 'GET') {
            const url = buildUrl(endpoint);
            const timestamp = new Date().toLocaleTimeString();
            
            // Log request to global log
            logToGlobalResponse(`üöÄ [${timestamp}] ${method} ${endpoint.toUpperCase()}`, 'request');
            logToGlobalResponse(`   ${url}`, 'info');
            
            try {
                // Show loading in global log
                const loadingId = Date.now();
                logToGlobalResponse(`‚è≥ Loading... (${loadingId})`, 'loading');

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                // Remove loading message from global log
                removeLoadingMessage(loadingId);

                const contentType = response.headers.get('content-type');
                let responseData;
                
                if (contentType && contentType.includes('application/json')) {
                    responseData = await response.json();
                    logToGlobalResponse(`‚úÖ [${timestamp}] Status: ${response.status} ${response.statusText}`, 'success');
                    logToGlobalResponse(JSON.stringify(responseData, null, 2), 'response');
                    
                    // Update snapshot display if it's a sync call
                    if (endpoint === 'sync' && responseData.names) {
                        updateSnapshotDisplay(responseData);
                    }
                } else {
                    responseData = await response.text();
                    logToGlobalResponse(`‚úÖ [${timestamp}] Status: ${response.status} ${response.statusText}`, 'success');
                    logToGlobalResponse(responseData, 'response');
                }

                logToGlobalResponse('‚îÄ'.repeat(80), 'info');

            } catch (error) {
                logToGlobalResponse(`‚ùå [${timestamp}] Error: ${error.message}`, 'error');
                logToGlobalResponse('‚îÄ'.repeat(80), 'info');
            }
        }

        // Call generic action (PIN mode only)
        async function callGenericAction(action) {
            if (apiMode !== 'pin') {
                alert('Generic action ch·ªâ kh·∫£ d·ª•ng ·ªü PIN mode');
                return;
            }

            baseUrl = document.getElementById('baseUrl').value;
            pinCode = document.getElementById('pinCode').value;
            const url = `${baseUrl}/api/court/${pinCode}/${action}`;
            const timestamp = new Date().toLocaleTimeString();
            
            logToGlobalResponse(`üöÄ [${timestamp}] POST ${action.toUpperCase()} (Generic)`, 'request');
            logToGlobalResponse(`   ${url}`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const responseData = await response.json();
                logToGlobalResponse(`‚úÖ [${timestamp}] Status: ${response.status} ${response.statusText}`, 'success');
                logToGlobalResponse(JSON.stringify(responseData, null, 2), 'response');
                logToGlobalResponse('‚îÄ'.repeat(80), 'info');

            } catch (error) {
                logToGlobalResponse(`‚ùå [${timestamp}] Error: ${error.message}`, 'error');
                logToGlobalResponse('‚îÄ'.repeat(80), 'info');
            }
        }

        // Validate PIN
        async function validatePin() {
            if (apiMode !== 'pin') {
                alert('PIN validation ch·ªâ kh·∫£ d·ª•ng ·ªü PIN mode');
                return;
            }
            await callApi('status', 'GET');
        }

        // SSE Functions
        function startSSE() {
            if (eventSource) {
                stopSSE();
            }

            const url = buildUrl('stream');
            document.getElementById('sseUrl').textContent = url;
            
            logToGlobalResponse(`üîå Connecting to SSE stream: ${url}`, 'info');
            
            eventSource = new EventSource(url);
            
            eventSource.onopen = function() {
                document.getElementById('sseStatus').textContent = 'Connected';
                document.getElementById('sseStatus').className = 'sse-status connected';
                logToGlobalResponse('üü¢ SSE connection opened', 'success');
            };

            eventSource.addEventListener('init', function(event) {
                const timestamp = new Date().toLocaleTimeString();
                logToGlobalResponse(`üì° [${timestamp}] SSE INIT event:`, 'info');
                try {
                    const data = JSON.parse(event.data);
                    logToGlobalResponse(JSON.stringify(data, null, 2), 'response');
                    updateSnapshotDisplay(data);
                } catch (e) {
                    logToGlobalResponse(event.data, 'response');
                }
                logToGlobalResponse('‚îÄ'.repeat(80), 'info');
            });

            eventSource.addEventListener('update', function(event) {
                const timestamp = new Date().toLocaleTimeString();
                logToGlobalResponse(`üì° [${timestamp}] SSE UPDATE event:`, 'success');
                try {
                    const data = JSON.parse(event.data);
                    logToGlobalResponse(JSON.stringify(data, null, 2), 'response');
                    updateSnapshotDisplay(data);
                } catch (e) {
                    logToGlobalResponse(event.data, 'response');
                }
                logToGlobalResponse('‚îÄ'.repeat(80), 'info');
            });

            eventSource.addEventListener('error', function(event) {
                const timestamp = new Date().toLocaleTimeString();
                logToGlobalResponse(`üì° [${timestamp}] SSE ERROR event:`, 'error');
                logToGlobalResponse(JSON.stringify(event, null, 2), 'error');
                logToGlobalResponse('‚îÄ'.repeat(80), 'info');
            });

            eventSource.onerror = function(error) {
                document.getElementById('sseStatus').textContent = 'Connection Error';
                document.getElementById('sseStatus').className = 'sse-status disconnected';
                logToGlobalResponse('üî¥ SSE connection error', 'error');
            };
        }

        function stopSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                document.getElementById('sseStatus').textContent = 'Disconnected';
                document.getElementById('sseStatus').className = 'sse-status disconnected';
                logToGlobalResponse('üî¥ SSE connection closed', 'error');
            }
        }

        // Update snapshot display
        function updateSnapshotDisplay(data) {
            if (!data.names) return;

            document.getElementById('snapshotDisplay').style.display = 'block';
            document.getElementById('teamAName').textContent = data.names[0] || 'Team A';
            document.getElementById('teamBName').textContent = data.names[1] || 'Team B';
            document.getElementById('teamAScore').textContent = data.score[0] || 0;
            document.getElementById('teamBScore').textContent = data.score[1] || 0;
            document.getElementById('teamAGames').textContent = `Games: ${data.games[0] || 0}`;
            document.getElementById('teamBGames').textContent = `Games: ${data.games[1] || 0}`;
            document.getElementById('gameNumber').textContent = data.gameNumber || 1;
            document.getElementById('bestOf').textContent = data.bestOf || 3;
            document.getElementById('server').textContent = data.server === 0 ? data.names[0] || 'Team A' : data.names[1] || 'Team B';
            document.getElementById('matchType').textContent = data.doubles ? 'Doubles' : 'Singles';
        }

        // Utility function to log to global response area
        function logToGlobalResponse(message, type = '') {
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `${message}\n`;
            globalLog.appendChild(logEntry);
            
            if (autoScroll) {
                globalLog.scrollTop = globalLog.scrollHeight;
            }
        }

        // Remove loading message
        function removeLoadingMessage(loadingId) {
            const loadingElements = globalLog.querySelectorAll('.loading');
            loadingElements.forEach(el => {
                if (el.textContent.includes(loadingId)) {
                    el.remove();
                }
            });
        }

        // Clear all logs
        function clearAllLogs() {
            globalLog.innerHTML = '';
            logToGlobalResponse('üßπ Log cleared at ' + new Date().toLocaleTimeString(), 'info');
        }

        // Toggle auto scroll
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.textContent = `Auto Scroll: ${autoScroll ? 'ON' : 'OFF'}`;
            btn.style.background = autoScroll ? '#6c757d' : '#dc3545';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            stopSSE();
        });
    </script>
</body>
</html>